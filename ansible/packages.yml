---
- hosts: all
  become: true
  remote_user: kuberoot

  tasks:
    # - name: Install lsb-release
    #   apt:
    #     name: lsb-release
    #     state: present

    # - name: Install curl
    #   apt:
    #     name: curl
    #     state: present

    # - name: Install gnupg
    #   apt:
    #     name: gnupg
    #     state: present

    # - name: Install ca-certificates
    #   apt:
    #     name: ca-certificates
    #     state: present

    # - name: Keyrings directory
    #   file:
    #     path: /etc/apt/keyrings
    #     state: directory

    # - name: Check if Docker GPG key exists
    #   stat:
    #     path: /etc/apt/keyrings/docker.gpg
    #   register: stat_result

    # - name: Download Docker GPG
    #   shell: |
    #     curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    #   when: not stat_result.stat.exists

    # - name: docker.list repository file
    #   blockinfile:
    #     path: /etc/apt/sources.list.d/docker.list
    #     block: |
    #       deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu focal stable
    #     create: true

    # - name: Install containerd
    #   apt:
    #     name: containerd.io
    #     state: present
    #     update_cache: yes

    - name: Remove cri from disabled_plugins in /etc/containerd/config.toml
      become: true
      become_user: root
      replace:
        path: /etc/containerd/config.toml
        regexp: "cri"
        replace: ""
        backup: yes
      register: containerd_config

    - name: Restart containerd service
      service:
        name: containerd
        state: restarted
      when: containerd_config.changed
